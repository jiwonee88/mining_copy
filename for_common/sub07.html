<?php
include_once('./_common.php');

add_stylesheet('<link rel="stylesheet" href="'.G5_THEME_URL.'/css/sub07.css">',1);

include_once('../_head.php');

if($history_page=='') $history_page='gold';

if($history_page=='gold'){

	if($year_stx!='' ) $point_table=$g5[cn_point]."_".$year_stx;
	else{
		$year_stx=date('ym');
		$point_table=$g5['cn_point']."_".date('ym');
	}

	if(chk_table($point_table)) {
		$sql_common = " from {$point_table} a ";
		$sql_search = " where mb_id='$member[mb_id]'  /* a.pkind in ('fee','fee2') */";

		if ($pkind_stx) {
			$sql_search .= " and a.pkind='$pkind_stx' ";	
			$qstr.="&pkind_stx=$pkind_stx";
		}
		if ($coin_stx) {	
			$sql_search .= " and a.ot_coin='$coin_stx' ";	
			$qstr.="&coin_stx=$coin_stx";
		}
		if($dates_stx){
			$sql_search .= " and a.wdate>='$dates_stx' ";	
			$qstr.="&dates_stx=$dates_stx";
		}
		if($datee_stx){
			$sql_search .= " and a.wdate<='$datee_stx 23:59:59' ";	
			$qstr.="&datee_stx=$datee_stx";
		}
		if($year_stx){
			$qstr.="&year_stx=$year_stx";
		}
		if($link_stx){
			$qstr.="&link_no=$link_stx";
		}

		if (!$sst) {
			$sst  = "a.pt_no ";
			$sod = "desc";
		}else{
			if($sst=='a.pkind') $sst  = " field(a.pkind,'".implode("','",array_keys($g5['cn_pkind']))."') ";
		}

		$sql_order = " order by $sst $sod ";

		$sql = " select count(*) as cnt {$sql_common} {$sql_search} {$sql_search_add}";
		$row = sql_fetch($sql,1);
		$total_count = $row['cnt'];

		$rows =15;
		$total_page  = ceil($total_count / $rows);  // 전체 페이지 계산
		if ($page < 1) { $page = 1; } // 페이지가 없으면 첫 페이지 (1 페이지)
		$from_record = ($page - 1) * $rows; // 시작 열을 구함

		$sql = " select a.*  $fields {$sql_common} {$sql_search}  {$sql_search_add} {$sql_order} limit {$from_record}, {$rows} ";
		$result = sql_query($sql);

	}
}


if($history_page=='shop'){


	if(chk_table($point_table)) {
		$sql_common = " from {$g5['cn_item_purchase']} a ";
		$sql_search = " where  mb_id='$member[mb_id]' ";


		$sql_order = " order by it_no desc ";

		$sql = " select count(*) as cnt {$sql_common} {$sql_search} {$sql_search_add}";
		$row = sql_fetch($sql,1);
		$total_count = $row['cnt'];

		$rows =15;
		$total_page  = ceil($total_count / $rows);  // 전체 페이지 계산
		if ($page < 1) { $page = 1; } // 페이지가 없으면 첫 페이지 (1 페이지)
		$from_record = ($page - 1) * $rows; // 시작 열을 구함

		$sql = " select a.*  $fields {$sql_common} {$sql_search}  {$sql_search_add} {$sql_order} limit {$from_record}, {$rows} ";
		$result = sql_query($sql,1);

	}
}

?>

    <section>
      <ul class="tabs">
        <li class="tab-link  <?=$history_page=='gold'?"current":""?>" onclick="document.location.href='./sub07.html?history_page=gold'" ><?=lng('골드내역')?></li>
        <li class="tab-link   <?=$history_page=='shop'?"current":""?>" onclick="document.location.href='./sub07.html?history_page=shop'"><?=lng('상점내역')?></li>
        <!--li class="tab-link" data-tab="tab-3"><?=lng('포인트내역')?></li-->
      </ul>

	
<? if($history_page=='gold'){?>
                <div  class="tab-content current">


				<form name="fsearch" id="fsearch" method="get">
				<div class='text-center m-2'>
				<select name="year_stx" id="year_stx" class='common-select w-100 mx-auto' onchange='this.form.submit();' >
				<option value=''>- Month Select -</option>
				<?
				$re=sql_query("SELECT * FROM information_schema.tables WHERE TABLE_NAME like '{$g5[cn_point]}\_%' and TABLE_NAME!= '{$g5[cn_pointsum]}' and TABLE_SCHEMA='".G5_MYSQL_DB."'  group by TABLE_NAME order by TABLE_NAME desc",1);
				while($td=sql_fetch_array($re)) {
				$val1=preg_replace("/".$g5[cn_point]."_/","",$td[TABLE_NAME]);
				$val2="20".substr($val1,0,2).'-'.substr($val1,2);
				echo "<option value='{$val1}' ".($year_stx==$val1 ? 'selected':'')." class='text-center' >{$val2}</option>";
				}
				?>
				</select>
				</div>
				</form>


                    <table>
                        <thead>
                            <tr>
						<th width="25%"><?=lng('날짜')?></th>
						<th width="25%"><?=lng('수량')?></th>
						<th width="50%"><?=lng('내용')?></th>
						</tr>
                        </thead>
                        <tbody class='text-narrow0' >
						<?php
	$list_num = $total_count - ($page - 1) * $rows;
	
    for ($i=0; $row=sql_fetch_array($result); $i++) {


    ?>
                            <tr>
                                <td><?=substr($row[wdate],0,10)?></td>
                                <td <?=$row[amount] < 0?"class='text-warning'":""?> ><?=number_format2($row[amount],1)?></td>
								<td class='text-left' ><?=$g5['cn_pkind'][$row[pkind]]?></td>
                            </tr>
	<?php
	$list_num--;
    }
    if ($i == 0)
        echo '<tr><td colspan="3" class="empty_table py-">'.lng("내역이 없습니다").'</td></tr>';
    ?>
     
                        </tbody>
                    </table>
					
							<div class='w-100 my-3 d-block'>
 <?=com_pager_print($total_page,$page,5,"&year_stx=$year_stx&history_page=$history_page&page=");?>
 </div>		
        
		
                </div>
<? }
?>



<? if($history_page=='shop'){?>
                <div  class="tab-content current">


                    <table>
                        <thead>
                            <tr>
						<th width="25%"><?=lng('날짜')?></th>
						<th width="25%"><?=lng('수량')?></th>
						<th width="50%"><?=lng('내용')?></th>
						</tr>
                        </thead>
                        <tbody class='text-narrow0' >
						<?php
	$list_num = $total_count - ($page - 1) * $rows;
	
    for ($i=0; $row=sql_fetch_array($result); $i++) {


    ?>
                            <tr>
                                <td><?=substr($row[it_wdate],0,10)?></td>
                                <td><?php echo number_format2($row['it_set_amt']) ?> <?=$g5['cn_cointype'][$row['it_set_token']]?></td>
								<td class='text-left' ><?=lng($g5['cn_item'][$row[cn_item]][name_kr])?> <?=$g5['purchase_stat'][$row[it_stat]]?></td>
                            </tr>
	<?php
	$list_num--;
    }
    if ($i == 0)
        echo '<tr><td colspan="3" class="empty_table py-5">'.lng("이용 내역이 없습니다").'</td></tr>';
    ?>
     
                        </tbody>
                    </table>
					
							<div class='w-100 my-3 d-block'>
 <?=com_pager_print($total_page,$page,5,"&year_stx=$year_stx&history_page=$history_page&page=");?>
 </div>		
        
		
                </div>
<? }
?>

     
    </section>

  </div>
  

<?	
include_once('../_tail.php');
?>