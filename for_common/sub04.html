<?php
include_once('./_common.php');

add_stylesheet('<link rel="stylesheet" href="'.G5_THEME_URL.'/css/sub04.css">',1);
add_javascript('<script src="'.G5_THEME_URL.'/extend/clipboard.min.js"></script>',1);

include_once('../_head.php');

//$last_date=date("Y-m-d",strtotime('-1 days'));
$last_date=date("Y-m-d");

?>
<style>
.orderCopyNum{font-size:0.9rem;}
</style>
    <section id="s01">
      <div class="s01_wraper">
        <div class="s01_01">
          <div class="myPage">
            <div class="profile">
              <img src="<?=G5_THEME_URL?>/images/p1.png" alt="profile" />
            </div>
           <div style="width:100%;padding-left:350px;">
            <div class="info">
              <p onclick="location.href='/for_common/sub08.html'"><?=$member[mb_id]?><span><?=lng('님')?></span></p>
              <button onclick="location.href='/for_common/sub08.html'"  class='angle-btn'><i class="fas fa-angle-double-right"></i></button>
            </div>
			</div>
            
          </div>
        </div>
        <div class="s01_03">
          <div class="buy">
            <h4><?=lng('구매')?></h4>
            <ul>
              <li onclick="location.href='/for_common/sub04.html?stats_stx=1-1'">
                <p><?=$buyer_stats[cnt_stats_1]>99?'+99':($buyer_stats[cnt_stats_1]?$buyer_stats[cnt_stats_1]:0)?><?=lng('건')?></p>
                <span><?=lng('미처리')?></span>
              </li>
              <li onclick="location.href='/for_common/sub04.html?stats_stx=1-2'" >
                <p><?=$buyer_stats[cnt_stats_2]>99?'+99':($buyer_stats[cnt_stats_2]?$buyer_stats[cnt_stats_2]:0)?><?=lng('건')?></p>
                <span><?=lng('완료대기')?></span>
              </li>
              <li onclick="location.href='/for_common/sub04.html?stats_stx=1-bad'" >
                <p><?=$buyer_stats[cnt_stats_claim]>99?'+99':($buyer_stats[cnt_stats_claim]?$buyer_stats[cnt_stats_claim]:0)?><?=lng('건')?></p>
                <span><?=lng('신고')?></span>
              </li>
              <li onclick="location.href='/for_common/sub04.html?stats_stx=1-3'" >
                <p><?=$buyer_stats[cnt_stats_3]>99?'+99':($buyer_stats[cnt_stats_3]?$buyer_stats[cnt_stats_3]:0)?><?=lng('건')?></p>
                <span class="com"><?=lng('완료')?></span>
              </li>
            </ul>
          </div>
          <div class="sell">
            <h4><?=lng('판매')?></h4>
            <ul>
              <li onclick="location.href='/for_common/sub04.html?stats_stx=2-1'">
                <p><?=$buyer_stats[cnt_stats_1]>99?'+99':($seller_stats[cnt_stats_1]?$seller_stats[cnt_stats_1]:0)?><?=lng('건')?></p>
                <span><?=lng('미처리')?></span>
              </li>
              <li onclick="location.href='/for_common/sub04.html?stats_stx=2-2'">
                <p><?=$seller_stats[cnt_stats_2]>99?'+99':($seller_stats[cnt_stats_2]?$seller_stats[cnt_stats_2]:0)?><?=lng('건')?></p>
                <span><?=lng('완료대기')?></span>
              </li>
              <li onclick="location.href='/for_common/sub04.html?stats_stx=2-3'">
                <p><?=$seller_stats[cnt_stats_3]>99?'+99':($seller_stats[cnt_stats_3]?$seller_stats[cnt_stats_3]:0)?><?=lng('건')?></p>
                <span class="com"><?=lng('완료')?></span>
              </li>
            </ul>
          </div>
        </div>
        <div class="s01_04">
          <ul>           
			
			<li  onclick="location.href='/for_common/sub08.html'">
              <p class='text-narrow2 small'>$ <?=number_format2($member[mb_trade_amtlmt])?></p>
              <span><?=lng('설정금액')?></span>
            </li>
            <!--li  onclick="location.href='/for_common/sub08.html'">
              <p class='text-narrow2 small'>$ <?=number_format2($isum[tot][price]>$member[mb_trade_amtlmt]?0:$member[mb_trade_amtlmt]-$isum[tot][price])?></p>
              <span><?=lng('가용금액')?></span>
            </li-->
            <li  onclick="location.href='/for_common/sub08.html'">
              <p class='text-narrow2 small'>$ <?=number_format2($isum[tot][price])?></p>
              <span class="com"><?=lng('보유금액')?></span>
            </li>
			
			
          </ul>
          <button onclick="location.href='/for_common/sub02.html'">AUTO HUNTING</button>
        </div>

<? 
if($stats_stx=='') $stats_stx='1-1';
//구매
if(preg_match("/^1/",$stats_stx)){

	$sql_common = " from {$g5['cn_item_trade']} a 
	left outer join  {$g5['member_table']} as b on(a.fmb_id=b.mb_id) ";
	$sql_search = " where (1) and a.mb_id='{$member[mb_id]}' ";
	if (!$sst) {
		$sst  = "a.tr_code ";
		$sod = "desc";
	}
	
	if($stats_stx=='1-1') $sql_search.=" and tr_stats='1' ";
	else if($stats_stx=='1-2') $sql_search.=" and tr_stats='2' ";
	else if($stats_stx=='1-bad') $sql_search.=" and (tr_buyer_claim='1' or tr_seller_claim='1' ) and tr_stats!='9' and tr_stats!='3'  ";
	else if($stats_stx=='1-3') $sql_search.=" and tr_wdate>='$last_date' and  tr_stats='3' ";
	
	$sql_order = " order by $sst $sod ";
	
	$sql = " select count(*) as cnt {$sql_common} {$sql_search}";
	$row = sql_fetch($sql,1);
	$total_count = $row['cnt'];

	$rows = $config['cf_mobile_page_rows'];
	$total_page  = ceil($total_count / $rows);  // 전체 페이지 계산
	if ($page < 1) { $page = 1; } // 페이지가 없으면 첫 페이지 (1 페이지)
	$from_record = ($page - 1) * $rows; // 시작 열을 구함

	

	$sql = " select a.*,b.mb_id bmb_id,b.mb_hp bmb_hp,b.mb_bank,b.mb_bank_num, b.mb_bank_user, b.mb_trade_paytype ,b.mb_name bmb_name,b.mb_level {$sql_common} {$sql_search} {$sql_order} limit {$from_record}, {$rows} ";
	$result = sql_query($sql,1);

	$list_num = $total_count - ($page - 1) * $rows;


for ($i=0; $row=sql_fetch_array($result); $i++) {

	$info=$g5[cn_item][$row[cn_item]];
	
	if($row[mb_level]=='9' || $row[mb_level]=='10')  $row[tr_distri]='hq';
?>

<div class="currentState">
		<form name='form_<?=$row[tr_code]?>' id='form_<?=$row[tr_code]?>'  >
			<input type='hidden' name='tr_code' value='<?=$row[tr_code]?>' >	
			<input type='hidden' name='w' value='txin' >	

          <div class="leftArea">
            <p>매수</p>
            <div class="thumnail"><img src="<?=G5_THEME_URL?>/images/item/<?=$g5[cn_item][$row[cn_item]][imgm]?>" alt="">
			
			</div>
          </div>
          <ul class="rightArea">		  
		  
            <li>
              <p><?=lng('주문번호')?></p>
              <p><?=lng($info[name_kr])?></p>
            </li>
            <li>
              <p><?=lng('구매자')?></p>
              <p><?=$row[smb_id]?></p>
            </li>
			<li>
              <p><?=lng('판매자')?></p>
              <p><?=$row[fsmb_id]?></p>
            </li>		
			
			<?
				if(  $row[tr_distri]=='hq'){?>
				<li> <p><?=lng('판매자 연락처')?></p>
			<p> 01042202346<br>01053772346
			 </p>
			</li>  	
				
			<? }else{?>
			<li><?=lng('판매자 이름')?> : <?=$row[mb_bank_user]?></li>
			<p><?=lng('판매자 연락처')?> : <?=$row[bmb_nation]?'+'.$row[bmb_nation]:$row[bmb_nation];?><?=$row[bmb_hp]?> </p>
			</li>  	
			<? }?>
			<?
			if($row[tr_paytype]!='cash'){

			if($row[tr_discount] > 0){?>					
			<li><p><?=lng('가격')?></p> <p>$ <?=number_format2($row[tr_price_org])?></p></li>	
			<li><p><?=lng('할인가격')?></p><p> $ <?=number_format2($row[tr_price])?></p></li>
			<li><p><?=lng('할인율')?> </p><p>  <?=number_format2($row[tr_discount])?>%</p></li>

			<? }else{?>
			<li><p><?=lng('가격')?></p><p> $<?=number_format2($row[tr_price])?></p></li>
<li><p>원화가격</p><p> ￦ <?=number_format2($row[tr_price]*$g5['cn_won_usd'])?></p></li>

			<? }
			}

			if( $row[tr_paytype]=='cash' || $row[tr_paytype]=='both' ){?>
			<li><p><?=lng('원화가격')?></p><p> ￦ <?=number_format2($row[tr_price_org]*$g5['cn_won_usd'])?></p></li>
			<? }?>
			
            <li>
              <p><?=lng('수수료')?></p>
              <p><?=number_format2($row[tr_fee])?> <?=$g5[cn_cointype][$row[cn_fee_coin]]?></p>
            </li>
			
            <li>
              <p><?=lng('상태')?></p>
              <p><?=lng($g5[tr_stat][$row[tr_stats]])?></p>
            </li>
			
			<li><p><?=lng('주문일')?></p><p><?=$row[tr_rdate]?></p></li>
			<li><p><?=lng('결제일')?></p><p><?=!preg_match("/^00/",$row[tr_paydate])?$row[tr_paydate]:'-'?></p></li>
			<li class='setdate-str'><p><?=lng('확정일')?> : <?=!preg_match("/^00/",$row[tr_setdate])?$row[tr_setdate]:'-'?></p></li>
			
          </ul>
		  
          <div class="sellerInfo deposit-bank d-none">
            <ul>			
				
				<?
					if($row[tr_paytype]=='cash' ||  $row[tr_paytype]=='both' || $row[tr_distri]=='hq') {?>
					<?
						//회사직영
						if($row[tr_distri]=='hq'){?>

						<li> <p><?=lng('은행명')?></p><p> <?=$cset[bank_name]?></p></li>
						<li> <p><?=lng('계좌번호')?></p><p> <?=$cset[bank_num]?></p></li>
						<li> <p><?=lng('예금주')?></p><p> <?=$cset[bank_user]?></p></li>	
						
						<?}else{?>					
						<li> <p><?=lng('은행명')?></p><p> <?=$row[tr_bank]?></p></li>
						<li> <p><?=lng('계좌번호')?></p><p> <?=$row[tr_bank_num]?></p></li>
						<li> <p><?=lng('예금주')?></p><p><?=$row[tr_bank_user]?></p></li>												  
						<? }?>
					<? }?>	
					<?
					if($row[tr_paytype]!='cash' && $row[tr_distri]!='hq'){?>
           			 <li class="btn-clipboard text-narrow0" data-clipboard-text="<?=$row[tr_wallet_addr]?>">
					 <p>USDT <?=lng('주소')?></p><p><?=$row[tr_wallet_addr]?></p></li>
					 <? }?>				
             
            </ul>
          </div>
		  <div class="bottomArea">
		  	
			<?
				if($row[tr_paytype]!='cash' && $row[tr_wallet_addr]!='' ){?>
                <input name="tr_txid" type="text" class="common-input my-1" id="tr_txid" value="<?=$row[tr_txid]?>" placeholder="Txid Hash <?=lng('복사 후 붙여넣기')?>">
                <div class="orderCopyNum w-80 mx-auto"> <?=lng('테더를 전송하는 경우에만 입력해주세요!')?></div>
                <div class="orderCopyNum w-80 mx-auto"> <?=lng('테더 구매시 txid를 입력치 않으면 구매완료 처리 되지 않습니다.')?> </div>
				<div class="orderCopyNum w-80 mx-auto text-center"><button type='button'  data-code="<?=$row[tr_code]?>" class='txid-btn w-auto px-3 '><?=lng('TXID조회')?></button></div>

				<? }?>
				
				<?
				if( $row[tr_bank_num]!='' || $row[tr_distri]=='hq'){?>
                <input name="tr_deposit" type="text" class="common-input mt-2" id="tr_deposit" value="<?=$row[tr_deposit]?>" placeholder="<?=lng('입금자명 + 아이디')?>">
				<div class="orderCopyNum w-80 mx-auto"> <?=lng('입금 후 입금자명을 반드시 입력해주세요!')?></div>				
                <div class="orderCopyNum w-80 mx-auto"> <?=lng('계좌 전송하는 경우에만 입력해주세요!')?></div>
                <div class="orderCopyNum w-80 mx-auto"> <?=lng('계좌 이체 시 기입하지 않으면 구매완료 처리 되지 않습니다.')?></div>

				<? }?>			
		 </div>
		  
		   <div class="sendInfo popupInfo popup-<?=$row[tr_code]?>" >	
		  	
            <h3><?=lng('신고하기')?></h3>
            <p class='px-5 mb-0 text-left' ><?=lng('신고사유를 입력하세요')?></p>
            <div class="w-100 text-center">
              <textarea name='tr_buyer_memo' id='tr_buyer_memo' class='w-80 common-textarea text-limit' text-limit-len='100' rows='4' ><?=$row[tr_buyer_memo]?></textarea>
				
				<p><is class='text-legnth-val'>0</is>/<?=lng('100자 이내')?></p>
            </div>
		
            <div class="btns">
              <button  type='button' class="mainBtn btn-buyer-claim" data-code='<?=$row[tr_code]?>'  ><?=lng('신고하기')?></button>
              <button type='button'  class="exit"><?=lng('닫기')?></button>
            </div>
          </div>
		  
		  
          <div class="bottomArea text-center">
              <button type='button' class='btn-bank w-20 mx-1' data-code="<?=$row[tr_code]?>" ><?=lng('입금정보')?></button>
              
			  
			  	<?
						
				if( (date("H") >= 17  && date("H") <= 23)  || (date("H") >= 0 && date("H") <= 8) || date("H") == 0 )  {?>				
			
				<button type='button' class='mainBtn btn-claim-open  w-20  mx-1' data-code='<?=$row[tr_code]?>' ><?=lng('신고')?></button>
			
				<? 
				}?>
				  <?
			if($row[tr_stats]=='1'){?>
			  <button type='button' class='btn-complete  w-20  mx-1' data-code='<?=$row[tr_code]?>' ><?=lng('결제확인')?></button>
              <? }?>

          </div>
		  </form>
        </div>

	<? }?>

<? }?>


<? 
//판매
if(preg_match("/^2/",$stats_stx)){

	$sql_common = " from {$g5['cn_item_trade']} a 
	left outer join  {$g5['member_table']} as b on(a.mb_id=b.mb_id) ";
	$sql_search = " where (1) and a.fmb_id='{$member[mb_id]}' ";
	if (!$sst) {
		$sst  = "a.tr_code ";
		$sod = "desc";
	}
	
	if($stats_stx=='2-1') $sql_search.=" and tr_stats='1' ";
	else if($stats_stx=='2-2') $sql_search.=" and tr_stats='2' ";
	else if($stats_stx=='2-bad') $sql_search.=" and (tr_buyer_claim='1' or tr_seller_claim='1' ) and tr_stats!='9' and tr_stats!='3'  ";
	else if($stats_stx=='2-3') $sql_search.=" and tr_wdate>='$last_date' and  tr_stats='3' ";
	
	
	$sql_order = " order by $sst $sod ";
	
	$sql = " select count(*) as cnt {$sql_common} {$sql_search}";
	$row = sql_fetch($sql,1);
	$total_count = $row['cnt'];

	$rows = $config['cf_mobile_page_rows'];
	$total_page  = ceil($total_count / $rows);  // 전체 페이지 계산
	if ($page < 1) { $page = 1; } // 페이지가 없으면 첫 페이지 (1 페이지)
	$from_record = ($page - 1) * $rows; // 시작 열을 구함

	

	$sql = " select a.*,b.mb_id bmb_id,b.mb_hp bmb_hp,b.mb_nation bmb_nation,b.mb_bank,b.mb_bank_num, b.mb_bank_user,b.mb_level  {$sql_common} {$sql_search} {$sql_order} limit {$from_record}, {$rows} ";
	$result = sql_query($sql,1);

	$list_num = $total_count - ($page - 1) * $rows;


for ($i=0; $row=sql_fetch_array($result); $i++) {

	$info=$g5[cn_item][$row[cn_item]];
	
	if($row[mb_level]=='9' || $row[mb_level]=='10')  $row[tr_distri]='hq';
?>	
			
<div class="currentState">
		<form name='form_<?=$row[tr_code]?>' id='form_<?=$row[tr_code]?>'  >
			<input type='hidden' name='tr_code' value='<?=$row[tr_code]?>' >	
			<input type='hidden' name='w' value='complete' >	

          <div class="leftArea">
            <p><?=lng('매도')?></p>
            <div class="thumnail"><img src="<?=G5_THEME_URL?>/images/item/<?=$g5[cn_item][$row[cn_item]][imgm]?>" alt="">
			
			</div>
          </div>
          <ul class="rightArea">		  
		  
            <li>
              <p><?=lng('주문번호')?></p>
              <p><?=lng($info[name_kr])?></p>
            </li>
            <li>
              <p><?=lng('구매자')?></p>
             <p><?=$row[smb_id]?> / <?=$row[mb_bank_user]?></p>
            </li>
			<li> <p><?=lng('구매자 연락처')?></p>
			<p> <?=$row[bmb_nation]?'+'.$row[bmb_nation]:$row[bmb_nation];?><?=$row[bmb_hp]?> </p>
			</li>  	
			<li>
              <p><?=lng('판매자')?></p>
              <p><?=$row[fsmb_id]?></p>
            </li>
			
			<?
				if(  $row[tr_distri]=='hq'){?>
				<li> <p><?=lng('판매자 연락처')?></p>
			<p> 01042202346<br>01053772346
			 </p>
			</li>  	
				
			<? }else{?>
			<li> <p><?=lng('판매자 연락처')?></p>
			<p> <?=$member[mb_nation]?'+'.$member[mb_nation]:$member[mb_nation];?><?=$member[mb_hp]?> </p>
			</li>  	
			<? }?>
			<?
			if($row[tr_paytype]!='cash'){

			if($row[tr_discount] > 0){?>					
			<li><p><?=lng('가격')?></p> <p>$ <?=number_format2($row[tr_price_org])?></p></li>	
			<li><p><?=lng('할인가격')?></p><p> $ <?=number_format2($row[tr_price])?></p></li>
			<li><p><?=lng('할인율')?> </p><p>  <?=number_format2($row[tr_discount])?>%</p></li>

			<? }else{?>
			<li><p><?=lng('가격')?></p><p> $<?=number_format2($row[tr_price])?></p></li>
					<? }
			}

			if( $row[tr_paytype]=='cash' || $row[tr_paytype]=='both' ){?>
			<li><p><?=lng('원화가격')?></p><p> ￦ <?=number_format2($row[tr_price_org]*$g5['cn_won_usd'])?></p></li>
			<? }?>
			
            <li>
              <p><?=lng('수수료')?></p>
              <p><?=number_format2($row[tr_fee])?> <?=$g5[cn_cointype][$row[cn_fee_coin]]?></p>
            </li>
			
            <li>
              <p><?=lng('상태')?></p>
              <p><?=lng($g5[tr_stat][$row[tr_stats]])?></p>
            </li>
			
			<li><p><?=lng('주문일')?></p><p><?=$row[tr_rdate]?></p></li>
			<li><p><?=lng('결제일')?></p><p><?=!preg_match("/^00/",$row[tr_paydate])?$row[tr_paydate]:'-'?></p></li>
			<li class='setdate-str'><p><?=lng('확정일')?> : <?=!preg_match("/^00/",$row[tr_setdate])?$row[tr_setdate]:'-'?></p></li>
			
          </ul>
		  
          <div class="sellerInfo deposit-bank d-none">
            <ul>			
				
				<?
					if($row[tr_paytype]=='cash' ||  $row[tr_paytype]=='both'|| $row[tr_distri]=='hq') {?>
					<?
						//회사직영
						if($row[tr_distri]=='hq'){?>

						<li> <p><?=lng('은행명')?></p><p> <?=$cset[bank_name]?></p></li>
						<li> <p><?=lng('계좌번호')?></p><p> <?=$cset[bank_num]?></p></li>
						<li> <p><?=lng('예금주')?></p><p> <?=$cset[bank_user]?></p></li>		
						
						<?}else{?>					
						<li> <p><?=lng('은행명')?></p><p> <?=$row[tr_bank]?></p></li>
						<li> <p><?=lng('계좌번호')?></p><p> <?=$row[tr_bank_num]?></p></li>
						<li> <p><?=lng('예금주')?></p><p><?=$row[tr_bank_user]?></p></li>	
						<? }?>
					<? }?>	
					<?
					if($row[tr_paytype]!='cash' && $row[tr_distri]!='hq'){?>
           			 <li class="btn-clipboard text-narrow0" data-clipboard-text="<?=$row[tr_wallet_addr]?>">
					 <p>USDT <?=lng('주소')?></p> <p class='d-block'><?=$row[tr_wallet_addr]?></p></li>
					 <? }?>				
             
            </ul>
          </div>
		  <div class="bottomArea">
		  	
			<?
				if($row[tr_paytype]!='cash' && $row[tr_wallet_addr]!='' ){?>
                <input name="tr_txid" type="text" class="common-input my-1" id="tr_txid" value="<?=$row[tr_txid]?>" readonly  >
				<div class="orderCopyNum w-80 mx-auto">Transaction Hash : <?=lng('테더 전송 거래 번호')?> </div>
		 		<div class="orderCopyNum w-80 mx-auto text-center"> <button type='button'  data-code="<?=$row[tr_code]?>" class='txid-btn w-auto px-3 '><?=lng('TXID조회')?></button></div>

				<? }?>
				
				<?
				if( $row[tr_bank_num]!='' || $row[tr_distri]=='hq'){?>
				
                <input name="tr_deposit" type="text" class="common-input mt-2" id="tr_deposit" value="<?=$row[tr_deposit]?>" readonly >
                <div class="orderCopyNum w-80 mx-auto text-center"><?=lng('계좌 이체시 입금자명')?></div>

				<? }?>				
		<?= $row[tr_distri]?>

		  </div>
		  
		    <div class="sendInfo popupInfo popup-<?=$row[tr_code]?>" >	
		  	
            <h3>신고하기</h3>
            <p class='px-5 mb-0 text-left' ><?=lng('신고사유를 입력하세요')?></p>
            <div class="w-100 text-center">
              <textarea name='tr_seller_memo' id='tr_seller_memo' class='w-80 common-textarea text-limit' text-limit-len='100' rows='4' ><?=$row[tr_buyer_memo]?></textarea>
				
				<p><is class='text-legnth-val'>0</is>/<?=lng('100자 이내')?></p>
            </div>
		
            <div class="btns">
              <button  type='button' class="mainBtn btn-seller-claim" data-code='<?=$row[tr_code]?>'  ><?=lng('신고하기')?></button>
              <button type='button'  class="exit"><?=lng('닫기')?></button>
            </div>
          </div>
		  
		  
		  
		  <div class="bottomArea text-center  mb-3">
               <button type='button' class='btn-bank  w-20  mx-1' data-code="<?=$row[tr_code]?>" ><?=lng('입금정보')?></button>
			  
			  	<?
						
				if( (date("H") >= 17  && date("H") <= 23)  || (date("H") >= 0 && date("H") <= 8) || date("H") == 0 )  {?>				
			
				<button type='button' class='mainBtn btn-claim-open  w-20  mx-1' data-code='<?=$row[tr_code]?>' ><?=lng('신고')?></button>
			
				<? 
				}?>
				
			  <?
			if($row[tr_stats]!='3'){?>
			
				<button type='button' class='btn-complete  w-20  mx-1' data-code='<?=$row[tr_code]?>' ><?=lng('입금확인')?></button>
			
			<? }?>
              
			
          </div>
		   <?
			if($row[tr_stats]!='3'){?>
		  <div class="text-center fs0875 mb-5 btn-complete-info ">
		  <?=lng('입금 확인 후 상대방으로 캐릭터를 반드시 보내야합니다')?>
		  </div>
		  <? }?>
			
		  </form>
        </div>

		
			<?}?>

<? }?>


<?
if(sql_num_rows($result)==0){?>
<div class='text-center mt-5'>
<?=lng('거래중인 '.$g5[cn_item_name].'이 없습니다')?>
</div>
<? }?>
<div class='w-100 d-block'>
 <?=com_pager_print($total_page,$page,is_mobile() ? $config['cf_mobile_pages'] : $config['cf_write_pages'],"&stats_stx=$stats_stx&page=");?>
 </div>

</div>
</section>

<script>
	$(document).ready(function () {
	
		$('.btn-bank').click(function () {
			event.preventDefault();
			var c=$(this).attr('data-code');
			 $('#form_'+c+" .deposit-bank").toggleClass('d-none');
			 
			 console.log(c);
			 
		});
		
		$('.btn-deposit').click(function () {			
			
			var c=$(this).attr('data-code');
			form_submit(c);
		});
		
		$('.btn-complete').click(function () {			
			event.preventDefault();
			Swal.fire({
			  title: '<?=lng('주의')?>',
			  text: "<?=lng('정말 거래 완료를 진행하시겠습니까? 완료된 거래는 재진행이 불가능합니다')?>",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: '<?=lng('진행합니다')?>'
			}).then((result) => {
			  if (result.value) {
				var c=$(this).attr('data-code');
				trade_end(c);
			  }
			})
			
			
		});
		
		
		var clipboard = new ClipboardJS('.btn-clipboard');
		clipboard.on('success', function(e) {
			Swal.fire({text:'<?=lng('복사완료')?>',timer:1000});

			var selection = window.getSelection();
			selection.removeAllRanges();
		});

		clipboard.on('error', function(e) {
			Swal.fire({text:'<?=lng('복사실패')?>',timer:1000});
		});
		
		
		$("button.txid-btn").click(function(){
			var c = $(this).attr('data-code');
			var txid=$("input[name='tr_txid']","#form_"+c).val();
			
			if(txid=='') {
				Swal.fire({text:'<?=lng('TXID가 입력되지 않았습니다')?>',timer:2000});   
				return 
			}

			window.open("https://etherscan.io/tx/"+txid);
		});
	
		//신고 팝업	
		 $(".btns button.exit").click(function () {
			$(this).closest('.sendInfo').removeClass("on");
			$(".mask").removeClass("on");
		});

		$('.btn-claim-open').click(function () {
			var c=$(this).attr('data-code');
			$('.popup-'+c).addClass('on').center();
			$(".mask").addClass("on");
		});		
		
		$('textarea.text-limit').on('keyup keypress',function () {			
			var limit=$(this).attr('text-limit-len');	
		 	var lng=$(this).val().length;
			if (lng > limit) {
				$(this).val($(this).val().substring(0, limit));
				return false;
			}
			$(this).next('p').find('.text-legnth-val').html(lng);			
		});
		
		//구매자 신고
		$('.btn-buyer-claim').click(function () {			
			event.preventDefault();
			Swal.fire({
			  title: '<?=lng('주의')?>',
			  text: "<?=lng('신고를 진행 하시겠습니까')?>",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: '<?=lng('진행합니다')?>'
			}).then((result) => {
			  if (result.value) {
				var c=$(this).attr('data-code');
				insert_claim(c,'buyer',$('#form_'+c+' textarea[name=tr_seller_memo]').val() );
			  }
			})
		});
		
		//판매자 신고
		$('.btn-seller-claim').click(function () {			
			event.preventDefault();
			Swal.fire({
			  title: '<?=lng('주의')?>',
			  text: "<?=lng('신고를 진행 하시겠습니까')?>",
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonColor: '#3085d6',
			  cancelButtonColor: '#d33',
			  confirmButtonText: '<?=lng('진행합니다')?>'
			}).then((result) => {
			  if (result.value) {
				var c=$(this).attr('data-code');
				insert_claim(c,'seller',$('#form_'+c+' textarea[name=tr_seller_memo]').val() );
			  }
			})
		});
			
	

	});
	
	//  테더지갑주소변경
	function form_submit(c)
	{

		event.preventDefault();
		var formData = $('#form_'+c).serialize();	

		$.ajax({
			type: "POST",
			url: "./incomplete.update.php",
			data:formData,
			cache: false,
			async: false,
			dataType:"json",
			success: function(data) {

				if(data.result==true){					
					$('#form_'+c +' .btn-complete').hide();	
					Swal.fire({text:'<?=lng('입금 확인 신청이 접수되었습니다')?>',timer:2000});   
				}
				else Swal.fire(data.message);       
			}
		});		
		return;
	}
	
	//  거래 종료
	function trade_end(c)
	{

		event.preventDefault();
		var formData = $('#form_'+c).serialize();	

		$.ajax({
			type: "POST",
			url: "./incomplete.update.php",
			data:formData,
			cache: false,
			async: false,
			dataType:"json",
			success: function(data) {

				if(data.result==true){					
					$('#form_'+c +' .stats-str').html('<?=lng('상태')?> : '+data.datas['stats']);
					$('#form_'+c +' .setdate-str').html('<?=lng('확정일')?> : '+data.datas['setdate']);
					$('#form_'+c +' .btn-complete').hide();
					$('#form_'+c +' .btn-complete-info').hide();
					Swal.fire({text:'<?=lng('거래를 종료하였습니다')?>',timer:2000});   
				}
				else Swal.fire(data.message);       
			}
		});		
		return;
	}
	
	
	//  신고
	function insert_claim(c,f,m)
	{

		event.preventDefault();
		
		$.ajax({
			type: "POST",
			url: "./incomplete.update.php",
			data:{w:'claim',tr_code:c,from:f,memo:m},
			cache: false,
			async: false,
			dataType:"json",
			success: function(data) {

				if(data.result==true){	
					if(f=='buyer'){
						$('#form_'+c +' .buyer-claim').html('<?=lng('구매자 신고중')?> : '+data.datas['tr_note']).removeClass('d-none');					
					}
					if(f=='seller'){
						$('#form_'+c +' .seller-claim').html('<?=lng('판매자 신고중')?> : '+data.datas['tr_note']).removeClass('d-none');						
					}
					Swal.fire({text:'<?=lng('신고되었습니다')?>',timer:2000});   
				}
				else Swal.fire(data.message);       
			}
		});		
		$('.popup-'+c).removeClass('on');
		$(".mask").removeClass("on");
		return;
	}
	
	
</script>


<?	
include_once('../_tail.php');
?>